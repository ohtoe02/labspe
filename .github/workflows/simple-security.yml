name: Simple Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write

jobs:
  simple-security:
    name: Simple Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Auto-discover and install
      run: |
        echo "ðŸ” Discovering project structure..."
        
        # ÐŸÐ¾Ð¸ÑÐº requirements.txt Ñ„Ð°Ð¹Ð»Ð¾Ð²
        if find . -name "requirements.txt" | head -1; then
          echo "ðŸ“¦ Installing from requirements.txt files..."
          find . -name "requirements.txt" -exec pip install -r {} \;
        fi
        
        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° security tools
        echo "ðŸ›¡ï¸ Installing security tools..."
        pip install bandit safety flake8 pylint pip-audit
        
        echo "âœ… Installation complete"
        
    - name: Run all security checks
      run: |
        echo "ðŸš€ Starting comprehensive security scan..."
        
        # Bandit - Static security analysis
        echo "ðŸ” Bandit scan..."
        bandit -r . -f txt --severity-level medium || true
        bandit -r . -f json -o bandit-report.json || true
        
        # Safety - Dependency vulnerabilities
        echo "ðŸ” Safety scan..."
        safety check || true
        safety check --json > safety-report.json 2>/dev/null || true
        
        # pip-audit - Additional dependency check
        echo "ðŸ” pip-audit scan..."
        pip-audit || true
        pip-audit --format=json --output=pip-audit-report.json || true
        
        # Flake8 - Code quality
        echo "ðŸ” Code quality check..."
        flake8 . --max-line-length=127 --statistics || true
        
        # Pylint - ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ app.py
        if find . -name "app.py" | head -1 > /dev/null; then
          echo "ðŸ” Pylint analysis..."
          find . -name "app.py" | head -1 | xargs pylint --exit-zero || true
        fi
        
        echo "âœ… All security checks completed"
      continue-on-error: true
      
    - name: Secrets scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
      
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: simple-security-reports-${{ github.run_number }}
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json
        retention-days: 15
        
    - name: Final summary
      if: always()
      run: |
        echo "# ðŸ›¡ï¸ Simple Security Demo Results" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ” Tools Executed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Bandit** - Python static analysis" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Safety** - Dependency vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **pip-audit** - Additional dependency scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Flake8** - Code quality" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **GitLeaks** - Secret detection" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "JSON reports available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âš ï¸ Educational Note" >> $GITHUB_STEP_SUMMARY
        echo "This simple Flask app contains intentional vulnerabilities for learning purposes." >> $GITHUB_STEP_SUMMARY 